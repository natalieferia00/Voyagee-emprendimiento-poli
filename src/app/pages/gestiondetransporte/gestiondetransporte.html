<p-toast></p-toast>
<p-confirmdialog></p-confirmdialog>

<div class="card">
    <div class="flex justify-between items-center mb-4">
        <div class="font-semibold text-xl text-800">Gestión de Transporte</div>
        <p-tag severity="contrast" 
               [style]="{'font-size': '1.1rem', 'padding': '8px 15px'}" 
               [value]="'Inversión Transporte: ' + (calcularTotal() | currency:'USD':'symbol':'1.0-2')">
        </p-tag>
    </div>

    <p-toolbar styleClass="mb-4">
        <ng-template pTemplate="start">
            <p-button label="Nuevo Viaje" icon="pi pi-plus" severity="success" (onClick)="openNew()"></p-button>
        </ng-template>
    </p-toolbar>

    <p-table #dt [value]="viajes()" [rows]="10" [paginator]="true" [rowHover]="true" dataKey="id" responsiveLayout="scroll">
        <ng-template pTemplate="header">
            <tr>
                <th>Ruta</th>
                <th>Medio</th>
                <th>Costo</th>
                <th class="text-center">Detalles</th>
                <th style="min-width: 12rem">Estado</th>
                <th>Acciones</th>
            </tr>
        </ng-template>
        
        <ng-template pTemplate="body" let-viaje>
            <tr>
                <td>
                    <div class="font-bold">
                        {{viaje.origen}} 
                        <i class="pi pi-arrow-right text-xs mx-1 text-500"></i> 
                        {{viaje.destino}}
                    </div>
                    <a *ngIf="viaje.urlProveedor" [href]="viaje.urlProveedor" target="_blank" class="text-xs text-blue-500 underline">
                        Link Proveedor
                    </a>
                </td>
                <td>
                    <p-tag [value]="viaje.medioTransporte" severity="secondary" [rounded]="true"></p-tag>
                </td>
                <td class="font-semibold text-primary">
                    {{viaje.costo | currency:'USD'}}
                </td>
                <td class="text-center">
                    <i *ngIf="viaje.descripcion" 
                       class="pi pi-eye text-primary cursor-pointer text-xl" 
                       [pTooltip]="viaje.descripcion" 
                       tooltipPosition="top">
                    </i>
                    <i *ngIf="!viaje.descripcion" class="pi pi-eye-slash text-300 text-xl"></i>
                </td>
                <td>
                    <p-select 
                        [(ngModel)]="viaje.estado" 
                        [options]="estados" 
                        optionLabel="label" 
                        optionValue="value"
                        (onChange)="onStatusChange(viaje, $event.value)"
                        appendTo="body"
                        styleClass="w-full border-none shadow-none bg-transparent">
                        <ng-template #selectedItem let-selectedOption>
                            <p-tag [value]="selectedOption.label.toUpperCase()" [severity]="getSeverity(selectedOption.value)"></p-tag>
                        </ng-template>
                        <ng-template let-option #item>
                            <p-tag [value]="option.label.toUpperCase()" [severity]="getSeverity(option.value)"></p-tag>
                        </ng-template>
                    </p-select>
                </td>
                <td>
                    <div class="flex gap-2">
                        <p-button icon="pi pi-pencil" [rounded]="true" [outlined]="true" (onClick)="editViaje(viaje)"></p-button>
                        <p-button icon="pi pi-trash" [rounded]="true" [outlined]="true" severity="danger" (onClick)="deleteViaje(viaje)"></p-button>
                    </div>
                </td>
            </tr>
        </ng-template>
    </p-table>
</div>

<p-dialog 
    [(visible)]="viajeDialog" 
    [style]="{ width: '550px' }" 
    header="Detalles del Transporte" 
    [modal]="true" 
    styleClass="p-fluid">
    
    <ng-template pTemplate="content">
        <div class="flex flex-col gap-5 pt-2">
            
            <div class="grid grid-cols-2 gap-4">
                <div class="flex flex-col gap-2">
                    <label class="font-bold text-700">Origen</label>
                    <input type="text" pInputText [(ngModel)]="viaje.origen" placeholder="Ciudad de inicio" />
                </div>
                <div class="flex flex-col gap-2">
                    <label class="font-bold text-700">Destino</label>
                    <input type="text" pInputText [(ngModel)]="viaje.destino" placeholder="Ciudad de fin" />
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div class="flex flex-col gap-2">
                    <label class="font-bold text-700">Medio de Transporte</label>
                    <p-select [options]="mediosTransporte" [(ngModel)]="viaje.medioTransporte" optionLabel="label" optionValue="value" placeholder="Seleccionar"></p-select>
                </div>
                <div class="flex flex-col gap-2">
                    <label class="font-bold text-700">Costo (USD)</label>
                    <p-inputNumber [(ngModel)]="viaje.costo" mode="currency" currency="USD" locale="en-US" placeholder="0.00"></p-inputNumber>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div class="flex flex-col gap-2">
                    <label class="font-bold text-700">Estado</label>
                    <p-select [options]="estados" [(ngModel)]="viaje.estado" optionLabel="label" optionValue="value">
                        <ng-template #selectedItem let-selectedOption>
                            <p-tag *ngIf="selectedOption" [value]="selectedOption.label.toUpperCase()" [severity]="getSeverity(selectedOption.value)"></p-tag>
                        </ng-template>
                    </p-select>
                </div>
                <div class="flex flex-col gap-2">
                    <label class="font-bold text-700">URL Proveedor</label>
                    <div class="p-inputgroup">
                        <span class="p-inputgroup-addon"><i class="pi pi-link"></i></span>
                        <input type="text" pInputText [(ngModel)]="viaje.urlProveedor" placeholder="https://..." />
                    </div>
                </div>
            </div>

            <div class="flex flex-col gap-2">
                <label class="font-bold text-700">Descripción (Horarios, Direcciones, Notas)</label>
                <textarea pTextarea [(ngModel)]="viaje.descripcion" rows="4" placeholder="Indica horarios, terminales o notas importantes..." style="resize: none"></textarea>
            </div>
        </div>
    </ng-template>

    <ng-template pTemplate="footer">
        <div class="flex justify-end gap-2 mt-2">
            <p-button label="Cancelar" icon="pi pi-times" [text]="true" severity="secondary" (onClick)="viajeDialog = false"></p-button>
            <p-button label="Guardar Viaje" icon="pi pi-check" severity="success" [raised]="true" (onClick)="saveViaje()"></p-button>
        </div>
    </ng-template>
</p-dialog>